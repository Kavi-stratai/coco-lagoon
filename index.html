<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Guest Reviews</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@500;700&display=swap"
    rel="stylesheet"
  />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: radial-gradient(circle, #00bcd4 0%, #007c91 100%);
      font-family: "Montserrat", sans-serif;
      color: #ffffff;
      text-align: center;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 20px;
    }

    h1#title-heading {
      font-size: 3rem;
      margin: 20px 0 10px;
      color: #fff;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.6);
      letter-spacing: 2px;
      font-weight: 700;
    }

    #name {
      font-size: 2.8rem;
      font-weight: 700;
      text-shadow: 1px 1px 6px black;
      margin-bottom: 8px;
      user-select: none;
    }

    #stars {
      font-size: 3rem;
      color: gold;
      margin: 12px 0;
      animation: pulse 1.2s infinite;
      user-select: none;
    }

    #review {
      font-family: "Pacifico", cursive;
      font-size: 2.2rem;
      color: #ffffff;
      padding: 0 30px;
      max-width: 90%;
      text-shadow: 1px 1px 6px #000;
      margin: 25px auto 35px;
      user-select: text;
      line-height: 1.3;
    }

    #emoji {
      font-size: 3.8rem;
      animation: bounce 1.4s infinite;
      user-select: none;
      margin-bottom: 30px;
    }

    @keyframes bounce {
      0%,
      100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-15px);
      }
    }

    @keyframes pulse {
      0%,
      100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    table#review-table {
      width: 95%;
      max-width: 900px;
      margin: 30px auto;
      border-collapse: separate;
      border-spacing: 0;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      color: #fff;
      font-size: 1.1rem;
      user-select: text;
    }

    table#review-table thead tr {
      background: rgba(255, 255, 255, 0.3);
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }

    table#review-table th,
    table#review-table td {
      padding: 14px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      text-align: left;
    }

    table#review-table tr:last-child td {
      border-bottom: none;
    }

    table#review-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.2);
      cursor: default;
      transition: background 0.3s ease;
    }

    /* Logo styles */
    #logo {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 120px;
      height: auto;
      opacity: 0.9;
      display: none; /* hidden by default */
      user-select: none;
      filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.5));
      z-index: 999;
    }

    /* Confetti styling unchanged */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: yellow;
      animation: fall 4s linear infinite;
      border-radius: 2px;
      opacity: 0.9;
      filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.3));
      pointer-events: none;
      z-index: 9999;
    }

    @keyframes fall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
    .summary-box {
  background: linear-gradient(145deg, #00e0ff, #005f73);
  padding: 20px 30px;
  border-radius: 20px;
  margin: 30px auto 0;
  text-align: center;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
  font-size: 1.2rem;
  max-width: 600px;
  color: #ffffff;
  animation: fadeIn 1.2s ease-out forwards;
}

.summary-box h2 {
  font-size: 1.6rem;
  margin-bottom: 10px;
}

.summary-box .stars {
  font-size: 2rem;
  color: gold;
  animation: pulse 1.5s infinite;
}

@keyframes fadeIn {
  0% {
    opacity: 0;
    transform: translateY(20px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

  </style>
</head>
<body>
  <h1 id="title-heading">Customer's Feedback </h1>
  <div id="name">Loading...</div>
  <div id="stars">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</div>
  <div id="review">Please wait...</div>
  <div id="emoji">üëè</div>

  <!-- Logo to show only with table -->
<img id="logo" src="https://yourdomain.com/path-to-your-logo.png" alt="" />
  
  <!-- Monthly Rating Summary (hidden by default) -->
<div id="monthly-summary" style="display: none; margin-top: 30px; padding: 20px 30px; background: rgba(0, 0, 0, 0.25); border-radius: 20px; font-size: 1.5rem; color: white; box-shadow: 0 0 15px rgba(0,0,0,0.3); max-width: 90%; backdrop-filter: blur(5px);">
  <div style="font-weight: bold; font-size: 1.8rem;">üåü May 2025 Rating Summary</div>
  <div style="font-size: 2rem; margin: 10px 0;" id="summary-stars">‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ <span style="color: gold;">(3.2/5)</span></div>
  <div>Rated by <span id="summary-count">14</span> guests. Thank you for your love üíô</div>
</div>

  <table id="review-table" style="display: none;"></table>
  <audio id="sound-clap" src="clap.mp3" preload="auto"></audio>
  <audio id="sound-neutral" src="neutral.mp3" preload="auto"></audio>
  <audio id="sound-sad" src="sad.mp3" preload="auto"></audio>

  <script>
  let lastReviewId = "";

  function createConfetti(count) {
    for (let i = 0; i < count; i++) {
      const confetti = document.createElement("div");
      confetti.className = "confetti";
      confetti.style.left = Math.random() * 100 + "vw";
      confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
      confetti.style.animationDuration = 2 + Math.random() * 3 + "s";
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 5000);
    }
  }

  function stopAllSounds() {
    ["sound-clap", "sound-neutral", "sound-sad"].forEach((id) => {
      const audio = document.getElementById(id);
      if (audio) {
        audio.pause();
        audio.currentTime = 0;
      }
    });
  }

  function showReviewDisplay(show) {
    document.getElementById("title-heading").innerText = show
      ? "Customer's Feedbacküíñ"
      : "üìã Recent Reviews";

    ["name", "stars", "review", "emoji"].forEach((id) => {
      document.getElementById(id).style.display = show ? "block" : "none";
    });

    const table = document.getElementById("review-table");
    table.style.display = show ? "none" : "table";

    document.getElementById("logo").style.display = show ? "none" : "block";
    document.getElementById("monthly-summary").style.display = show ? "none" : "block";
  }

  async function fetchReviews() {
    try {
      // üëá Cache-busting added here
      const res = await fetch("https://script.google.com/macros/s/AKfycbzCUa2j8pSz_cr4HUQIRvHJ40IGU8UhJRJXxUpiapm1zJ7vZWumjoDQ-bm5D18SCCNo/exec?cacheBust=" + Date.now());
      const data = await res.json();
      const latest = data[data.length - 1];

      const reviewId = JSON.stringify([
  latest["Table Number"] || latest.name || latest.Name || "?",
  latest.rating || latest.Rating || "?",
  latest.comment || latest.Comment || latest.review || latest.Review || "?",
  (latest.timestamp || latest.Timestamp || latest.time || "").trim()
]);



      if (reviewId !== lastReviewId) {
  lastReviewId = reviewId;

  const rawValue = latest["Table Number"] || latest.name || latest.Name || "?";
  const displayName = /^[0-9]+$/.test(rawValue)
    ? `Table ${rawValue}`
    : `Guest ${rawValue}`;
  const rating = latest.rating || latest.Rating || "?";
  const review = latest.comment || latest.Comment || latest.review || latest.Review || "";

  document.getElementById("name").innerText = `${displayName} gave ${rating} ‚≠êÔ∏è`;
  document.getElementById("stars").innerText = "‚≠êÔ∏è".repeat(Number(rating));
  document.getElementById("review").innerText = `‚Äú${review}‚Äù`;

  const emojiEl = document.getElementById("emoji");

  stopAllSounds();

  if (Number(rating) >= 4) {
    emojiEl.innerText = "üéäüéâüëè";
    document.getElementById("sound-clap").play().catch(() => {});
    createConfetti(40);
  } else if (Number(rating) === 3) {
    emojiEl.innerText = "üôÇ";
    document.getElementById("sound-neutral").play().catch(() => {});
  } else {
    emojiEl.innerText = "üòû";
    document.getElementById("sound-sad").play().catch(() => {});
  }

  showReviewDisplay(true);

  setTimeout(() => {
    stopAllSounds();
    showReviewDisplay(false);
  }, 4000);
}

// ‚úÖ Always update the table & summary
populateTable(data);

    } catch (err) {
      console.error("Failed to fetch reviews", err);
    }
  }

  function populateTable(data) {
    const table = document.getElementById("review-table");
    table.innerHTML =
      "<thead><tr><th>Table</th><th>Rating</th><th>Comment</th><th>Time</th></tr></thead><tbody></tbody>";

    const tbody = table.querySelector("tbody");
    const latestFive = data.slice(-5).reverse(); 

    latestFive.forEach((entry) => {
      const row = document.createElement("tr");

      const tableNum = entry["Table Number"] || entry.name || entry.Name || "?";
      const rating = Number(entry.rating || entry.Rating || 0);
      const stars = "‚≠êÔ∏è".repeat(rating);
      const comment =
        entry.comment || entry.Comment || entry.review || entry.Review || "";
      const timestamp = (entry.timestamp || entry.Timestamp || entry.time || "‚Äî").trim();


      row.innerHTML = `
        <td>${tableNum}</td>
        <td>${stars}</td>
        <td>${comment}</td>
        <td>${timestamp}</td>
      `;

      tbody.appendChild(row);
    });

    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    const monthRatings = [];

    data.forEach((entry) => {
      const tsRaw = entry.Timestamp || entry.timestamp || entry.time || "";
      const ratingRaw = Number(entry.rating || entry.Rating);
      if (isNaN(ratingRaw)) return;

      let dateObj;
      try {
        dateObj = new Date(tsRaw);
        if (isNaN(dateObj)) return;
      } catch {
        return;
      }

      if (
        dateObj.getMonth() === currentMonth &&
        dateObj.getFullYear() === currentYear
      ) {
        monthRatings.push(ratingRaw);
      }
    });

    const total = monthRatings.reduce((a, b) => a + b, 0);
    const avg = monthRatings.length
      ? (total / monthRatings.length).toFixed(1)
      : "0.0";
    const starsDisplay =
      "‚≠êÔ∏è".repeat(Math.round(avg)) + "‚òÜ".repeat(5 - Math.round(avg));

    const monthLabel = now.toLocaleString("default", { month: "long" });

    document.querySelector("#monthly-summary div:first-child").innerText =
      `üåü ${monthLabel} ${currentYear} Rating Summary`;

    document.getElementById("summary-stars").innerHTML =
      `${starsDisplay} <span style="color: gold;">(${avg}/5)</span>`;
    document.getElementById("summary-count").innerText = monthRatings.length;
  }

  fetchReviews();
  setInterval(fetchReviews, 1000);
</script>

</body>
</html>
